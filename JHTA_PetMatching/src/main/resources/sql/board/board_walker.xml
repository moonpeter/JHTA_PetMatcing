<?xml version="1.0" encoding="UTF-8" ?><!-- SQL 맵퍼 파일은 xml이기 때문에 제일 먼저 xml 선언이 옵니다. -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="DwBoard">

	<select id="count" resultType="int">
		select count(*) from dw_board
	</select>

	<!-- 문법 오류
		1. where rnum >=  #{start}
		
		HTML 문서는 '<', '.', '>' 와 같은 마크업 문자들을 피싱해서 읽어들이는 구조입니다.
		그래서 마크업 문자들을 원래대로의 의미로 사용하기 위해서 '&gt;', '&lt;', '&nbsp;' 등의
		escape 문자열 (escape character)을 이용해야 하는데 문장이
		길어지는 문제점이 발생하게 됩니다. 이럴 때 사용하는 것이 바로 CDATA(character DATA) 절입니다.
		파서는 <![CDATA[ 와 ]]> 사이의 문장을 단순한 문자데이터로 인식하게 됩니다.
		
		2. > : &gt;
		   < : &lt;
		   바꾸어 보세요
	 -->

	<select id="list" parameterType="java.util.Map" resultType="board">
		select * from
			( select rownum rnum, b.*
				from
					(select * from dw_board
					 order by BOARD_RE_REF desc,
					 BOARD_RE_SEQ asc) b
			)
			where rnum &gt;= #{start} and rnum &lt;= #{end}
	</select>
	
	<insert id = "insert" parameterType="board">
		<selectKey resultType="int"		order="BEFORE"	keyProperty="BOARD_NUM">
			select nvl(max(BOARD_NUM),0)+1 from dw_board
		</selectKey>
		insert into dw_board
		(BOARD_NUM, BOARD_NAME, BOARD_PASS, BOARD_SUBJECT,
		 BOARD_CONTENT, BOARD_FILE, BOARD_ORIGINAL,
		 BOARD_RE_REF,
		 BOARD_RE_LEV, BOARD_RE_SEQ, BOARD_READCOUNT,
		 BOARD_DATE)
		 values
		 (#{BOARD_NUM},
		  #{BOARD_NAME}, #{BOARD_PASS}, #{BOARD_SUBJECT},
		  #{BOARD_CONTENT}, #{BOARD_FILE, jdbcType=VARCHAR},
		  #{BOARD_ORIGINAL, jdbcType=VARCHAR}, 
		  #{BOARD_NUM},
		  #{BOARD_RE_LEV}, #{BOARD_RE_SEQ}, #{BOARD_READCOUNT},
		  sysdate)
	</insert>
	
	<update id = "readCountUpdate" parameterType="int">
		update dw_board
		set BOARD_READCOUNT = BOARD_READCOUNT + 1
		where BOARD_NUM = #{number}
	</update> 
	
	<select id="detail" parameterType="int" resultType="board" >
		select * from dw_board where BOARD_NUM = #{number}
	</select>
	
	
	<update id="modify" parameterType="board">
		update dw_board
		set
			BOARD_SUBJECT=#{BOARD_SUBJECT},
			BOARD_CONTENT=#{BOARD_CONTENT},
			BOARD_FILE=#{BOARD_FILE, jdbcType=VARCHAR},
			BOARD_ORIGINAL=#{BOARD_ORIGINAL, jdbcType=VARCHAR}
		where BOARD_NUM=#{BOARD_NUM}
	</update>
	
	
	<!--  map 은 java.util.Map의 별칭입니다.-->
	<select id="boardWriter" parameterType="map"
		resultType="board">
			select * from dw_board
			where BOARD_NUM=#{num}
			and BOARD_PASS=#{pass}
		</select>
	
	<update id="reply_update" parameterType="board">
		update 	 dw_board 
		set		 BOARD_RE_SEQ = BOARD_RE_SEQ+1
		where 	 BOARD_RE_REF = #{BOARD_RE_REF}
		and 	 BOARD_RE_SEQ <![CDATA[>]]> #{BOARD_RE_SEQ}
	</update>
	
	<!-- BOARD_FILE, BOARD_ORIGINAL 필드 없어요 -->
	
	<insert id="reply_insert" parameterType="board">
	   <selectKey resultType="int" order="BEFORE" keyProperty="BOARD_NUM">
	      select nvl(max(BOARD_NUM),0)+1 from dw_board
	    </selectKey>
	   insert into dw_board 
	   (BOARD_NUM,BOARD_NAME,BOARD_PASS, BOARD_SUBJECT,
	    BOARD_CONTENT, BOARD_RE_REF, BOARD_RE_LEV,BOARD_RE_SEQ,
		BOARD_READCOUNT,BOARD_DATE) 
		values(#{BOARD_NUM},
		#{BOARD_NAME},#{BOARD_PASS},#{BOARD_SUBJECT},
		#{BOARD_CONTENT}, #{BOARD_RE_REF},#{BOARD_RE_LEV},
		#{BOARD_RE_SEQ},#{BOARD_READCOUNT},sysdate)
	</insert>
	
	<delete id="delete" parameterType="board">
	<![CDATA[	
		delete from	 dw_board 
		where 	 BOARD_RE_REF =  #{BOARD_RE_REF}
		and 	 BOARD_RE_LEV >= #{BOARD_RE_LEV}
		and 	 BOARD_RE_SEQ >= #{BOARD_RE_SEQ}
		and 	 BOARD_RE_SEQ <= (
									nvl((select min(board_re_seq)-1
									from 	dw_board
									where 	BOARD_RE_REF = #{BOARD_RE_REF}
									and 	BOARD_RE_LEV = #{BOARD_RE_LEV}
									and 	BOARD_RE_SEQ > #{BOARD_RE_SEQ}),
									(select max(board_re_seq)
									from 	dw_board
									where 	BOARD_RE_REF=#{BOARD_RE_REF}))
								  )
		]]>
	</delete>
	
	<insert id="insert_deleteFile" parameterType="String">
		insert into delete_file
		values(#{file})
	</insert>
	
	<select id="deleteFileList" resultType="String">
		select board_file from delete_file
	</select>
	
	
</mapper>